<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ä»»åŠ¡å®Œæˆç¡®è®¤</title>
<style>
  :root { --pri:#1677ff; --mut:#f2f3f5; }
  body{font-family:system-ui,Arial;margin:24px}
  .card{max-width:760px;margin:0 auto;border:1px solid #eee;border-radius:14px;padding:20px 22px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  h1{font-size:22px;margin:0 0 14px}
  .row{margin:10px 0;word-break:break-all}
  .k{display:inline-block;min-width:84px;color:#666}
  textarea{width:100%;min-height:120px;padding:12px;border:1px solid #ddd;border-radius:10px;font:inherit}
  button{padding:12px 16px;border:0;border-radius:10px;cursor:pointer;font-weight:600}
  .primary{background:var(--pri);color:#fff}
  .muted{background:var(--mut);color:#333;margin-left:8px}
  .disabled{opacity:.5;cursor:not-allowed}
  .ok{color:#0a8;font-weight:600}
  .err{color:#d33;font-weight:600}
  .hint{font-size:12px;color:#777}
</style>
</head>
<body>
<div class="card">
  <h1>ä»»åŠ¡å®Œæˆç¡®è®¤</h1>

  <div class="row"><span class="k">ä»»åŠ¡ï¼š</span><span id="subject">-</span></div>
  <div class="row"><span class="k">æ‰§è¡Œäººï¼š</span><span id="executor">-</span></div>
  <div class="row"><span class="k">sourceIdï¼š</span><span id="sid">-</span></div>

  <div class="row"><span class="k">å¤‡æ³¨ï¼š</span></div>
  <div class="row"><textarea id="remark" placeholder="å¡«å†™æ‰§è¡Œæƒ…å†µï¼ˆå¯é€‰ï¼‰"></textarea></div>

  <div class="row">
    <button id="submitBtn" class="primary">å®Œæˆå¹¶æäº¤</button>
    <button id="viewBtn" class="muted">ä»…æŸ¥çœ‹</button>
  </div>

  <div class="row" id="status"></div>
  <div class="row hint">
    è¯´æ˜ï¼šä»…ä½¿ç”¨ GitHub Pagesã€‚é‡‡ç”¨â€œæœ¬æœºé”å®š + åªè¯»é“¾æ¥â€é˜²é‡å¤ï¼›æ¢è®¾å¤‡/æ¸…ç¼“å­˜ä»å¯èƒ½å†æ¬¡æäº¤ï¼Œç¾¤æ¶ˆæ¯ä¼šåŒ…å« <code>sourceId</code> ä¾¿äºè¯†åˆ«ã€‚
  </div>
</div>

<script>
  // ========= 1) ä½ çš„é»˜è®¤é’‰é’‰æœºå™¨äººé…ç½®ï¼ˆå»ºè®®è‡³å°‘å¡«å†™ webhookï¼‰ =========
  const DING_WEBHOOK_DEFAULT = "åœ¨è¿™é‡Œå¡«ä½ çš„æœºå™¨äººWebhook"; // ä¾‹: https://oapi.dingtalk.com/robot/send?access_token=xxxx
  const DING_SECRET_DEFAULT  = ""; // è‹¥æœºå™¨äººå®‰å…¨=åŠ ç­¾ï¼Œå¡«å¯†é’¥ï¼›è‹¥ä½¿ç”¨â€œå…³é”®å­—â€å®‰å…¨ï¼Œå¯ç•™ç©º

  // ========= 2) è¯»å– URL å‚æ•°ï¼ˆå¯è¦†ç›–é»˜è®¤é…ç½®ï¼‰ =========
  const P = new URLSearchParams(location.search);
  const subject  = P.get('subject') || 'æœªå‘½åä»»åŠ¡';
  const sourceId = (P.get('sourceId') || '').trim();
  const executor = P.get('executorUnionId') || P.get('executor') || '';
  const creator  = P.get('creatorUnionId') || '';
  const readonlyParam = P.get('readonly') === '1';
  const DING_WEBHOOK = decodeURIComponent(P.get('dingWebhook') || '') || DING_WEBHOOK_DEFAULT;
  const DING_SECRET  = decodeURIComponent(P.get('dingSecret')  || '') || DING_SECRET_DEFAULT;

  // ========= 3) æ¸²æŸ“åŸºæœ¬ä¿¡æ¯ =========
  const $ = id => document.getElementById(id);
  $('subject').textContent = subject;
  $('executor').textContent = executor || '(æœªä¼ )';
  $('sid').textContent     = sourceId || '(æœªä¼ )';
  const btn = $('submitBtn'), viewBtn = $('viewBtn');
  const remarkEl = $('remark'), statusEl = $('status');

  function setStatus(html){ statusEl.innerHTML = html; }
  function disableSubmit(msg){
    btn.disabled = true; btn.classList.add('disabled');
    remarkEl.readOnly = true;
    if (msg) setStatus(msg);
  }

  // ========= 4) é’‰é’‰åŠ ç­¾ï¼ˆå¦‚æœå¯ç”¨äº†â€œåŠ ç­¾â€å®‰å…¨ï¼‰ =========
  async function signDing(secret, timestamp) {
    const enc = new TextEncoder();
    const key = await crypto.subtle.importKey("raw", enc.encode(secret), {name:"HMAC", hash:"SHA-256"}, false, ["sign"]);
    const sig = await crypto.subtle.sign("HMAC", key, enc.encode(timestamp + "\n" + secret));
    const base64 = btoa(String.fromCharCode(...new Uint8Array(sig)));
    return encodeURIComponent(base64);
  }

  // ========= 5) å‘é€é’‰é’‰æ¶ˆæ¯ï¼ˆMarkdownï¼‰ =========
  async function sendToDingTalk(payload) {
    if (!DING_WEBHOOK) return { ok:false, msg:"æœªé…ç½®é’‰é’‰ webhook" };

    let url = DING_WEBHOOK.trim();
    if (DING_SECRET) {
      const ts = Date.now();
      const sign = await signDing(DING_SECRET, ts);
      url += (url.includes('?') ? '&' : '?') + `timestamp=${ts}&sign=${sign}`;
    }

    const text =
`**ä»»åŠ¡å®Œæˆ**
- ä»»åŠ¡ï¼š${payload.subject}
- æ‰§è¡Œäººï¼š${payload.executor || "-"}
- sourceIdï¼š${payload.sourceId}
- å¤‡æ³¨ï¼š${payload.remark || "-"}
- å®Œæˆæ—¶é—´ï¼š${new Date(payload.ts).toLocaleString('zh-CN')}`;

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json;charset=utf-8" },
      body: JSON.stringify({ msgtype: "markdown", markdown: { title: "ä»»åŠ¡å®Œæˆ", text } })
    });
    const data = await resp.json().catch(()=> ({}));
    return { ok: data.errcode === 0, msg: JSON.stringify(data) };
  }

  // ========= 6) è¿›å…¥é¡µé¢ï¼šåªè¯»åˆ¤å®šï¼ˆæœ¬æœºé” + URLï¼‰ =========
  const LOCK_KEY = sourceId ? 'done_' + sourceId : '';
  (function init(){
    if (!sourceId){ disableSubmit('<span class="err">ç¼ºå°‘ sourceIdï¼Œæ— æ³•æäº¤ã€‚</span>'); return; }
    const localLocked = localStorage.getItem(LOCK_KEY) === '1';
    if (localLocked || readonlyParam) {
      disableSubmit('ğŸ‘€ å½“å‰ä¸ºåªè¯»æ¨¡å¼ã€‚');
    } else {
      setStatus('âœ… å¯æäº¤ã€‚');
    }
  })();

  // ========= 7) ä»…æŸ¥çœ‹ï¼šä¸æäº¤ï¼Œåˆ‡æ¢åªè¯»é“¾æ¥ =========
  viewBtn.addEventListener('click', ()=>{
    disableSubmit('ğŸ‘€ å·²åˆ‡æ¢ä¸ºä»…æŸ¥çœ‹æ¨¡å¼ã€‚');
    const u = new URL(location.href);
    u.searchParams.set('readonly','1');
    history.replaceState(null,'',u.toString());
  });

  // ========= 8) å®Œæˆå¹¶æäº¤ï¼šå‘é’‰é’‰ + æœ¬æœºé” + åªè¯»é“¾æ¥ =========
  btn.addEventListener('click', async ()=>{
    if (btn.disabled) return;
    if (!sourceId){ setStatus('<span class="err">ç¼ºå°‘ sourceIdã€‚</span>'); return; }

    btn.disabled = true; btn.classList.add('disabled');
    setStatus('â³ æäº¤ä¸­â€¦');
    const payload = {
      subject, sourceId, executor, creator,
      remark: remarkEl.value || '',
      ts: Date.now()
    };

    try {
      const res = await sendToDingTalk(payload);
      if (res.ok) {
        localStorage.setItem(LOCK_KEY, '1');          // æœ¬æœºé”
        const u = new URL(location.href);             // åˆ‡åªè¯»é“¾æ¥
        u.searchParams.set('readonly','1');
        history.replaceState(null,'',u.toString());
        disableSubmit('âœ… å·²æäº¤ï¼Œå·²æ¨é€åˆ°ç¾¤ï¼Œé¡µé¢å·²é”å®šä¸ºåªè¯»ã€‚');
      } else {
        setStatus('<span class="err">é’‰é’‰æ¨é€å¤±è´¥ï¼š</span>' + res.msg);
        btn.disabled = false; btn.classList.remove('disabled');
      }
    } catch (e) {
      setStatus('<span class="err">ç½‘ç»œå¼‚å¸¸ï¼š</span>' + e);
      btn.disabled = false; btn.classList.remove('disabled');
    }
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>任务反馈</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 30px auto; }
    h2 { color: #333; }
    textarea { width: 100%; height: 120px; margin: 10px 0; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; }
    #submitBtn { background-color: #1677ff; color: white; }
    #viewBtn { background-color: #eee; }
    #submitBtn.disabled { background-color: #999; cursor: not-allowed; }
  </style>
</head>
<body>
  <h2>任务完成确认</h2>
  <p>任务：<span id="subject">-</span></p>
  <p>执行人：<span id="executor">-</span></p>
  <p>sourceId：<span id="sourceId">-</span></p>
  <p>备注:</p>
  <textarea id="remark"></textarea><br>
  <button id="submitBtn">完成并提交</button>
  <button id="viewBtn">仅查看</button>

  <script>
    // 1) 改成你的 Worker 地址（记得替换成实际 workers.dev）
    const RELAY_ENDPOINT = "https://dingtalk-relay.jb2909825662.workers.dev/";

    // 2) 从 URL 获取参数
    const P = new URLSearchParams(location.search);
    const subject  = P.get('subject') || "演示任务";
    const executor = P.get('executor') || "张三";
    const sourceId = P.get('sourceId') || "demo-001";

    // 显示到页面
    document.getElementById("subject").innerText = subject;
    document.getElementById("executor").innerText = executor;
    document.getElementById("sourceId").innerText = sourceId;

    // 3) 封装调用 Worker 的函数
    async function sendToDingTalk({ subject, executor, sourceId, remark }) {
      const body = {
        payload: {
          msgtype: "markdown",
          markdown: {
            title: "任务完成",
            text: `**任务完成**
- 任务：${subject}
- 执行人：${executor}
- sourceId：${sourceId}
- 备注：${remark || "-"}
- 完成时间：${new Date().toLocaleString('zh-CN')}`
          }
        }
      };

      const r = await fetch(RELAY_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      return r.json().catch(() => ({}));
    }

    // 4) 绑定按钮事件
    const btn = document.getElementById("submitBtn");
    const remarkEl = document.getElementById("remark");

    btn.addEventListener("click", async () => {
      btn.disabled = true;
      btn.classList.add("disabled");
      btn.innerText = "提交中...";

      const result = await sendToDingTalk({
        subject,
        executor,
        sourceId,
        remark: remarkEl.value
      });

      if (result.errcode === 0) {
        remarkEl.readOnly = true;
        btn.innerText = "已提交";
        alert("提交成功，已推送到钉钉群");
      } else {
        btn.disabled = false;
        btn.classList.remove("disabled");
        btn.innerText = "完成并提交";
        alert("提交失败: " + JSON.stringify(result));
      }
    });

    document.getElementById("viewBtn").addEventListener("click", () => {
      remarkEl.readOnly = true;
      btn.disabled = true;
      btn.classList.add("disabled");
      btn.innerText = "只读模式";
    });
  </script>
</body>
</html>

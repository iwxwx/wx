<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>任务完成确认</title>
<style>
  :root { --pri:#1677ff; --mut:#f2f3f5; }
  body{font-family:system-ui,Arial;margin:24px}
  .card{max-width:760px;margin:0 auto;border:1px solid #eee;border-radius:14px;padding:20px 22px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  h1{font-size:22px;margin:0 0 14px}
  .row{margin:10px 0;word-break:break-all}
  .k{display:inline-block;min-width:84px;color:#666}
  textarea{width:100%;min-height:120px;padding:12px;border:1px solid #ddd;border-radius:10px;font:inherit}
  button{padding:12px 16px;border:0;border-radius:10px;cursor:pointer;font-weight:600}
  .primary{background:var(--pri);color:#fff}
  .muted{background:var(--mut);color:#333;margin-left:8px}
  .disabled{opacity:.5;cursor:not-allowed}
  .ok{color:#0a8;font-weight:600}
  .err{color:#d33;font-weight:600}
  .hint{font-size:12px;color:#777}
</style>
</head>
<body>
<div class="card">
  <h1>任务完成确认</h1>

  <div class="row"><span class="k">任务：</span><span id="subject">-</span></div>
  <div class="row"><span class="k">执行人：</span><span id="executor">-</span></div>
  <div class="row"><span class="k">sourceId：</span><span id="sid">-</span></div>

  <div class="row"><span class="k">备注：</span></div>
  <div class="row"><textarea id="remark" placeholder="填写执行情况（可选）"></textarea></div>

  <div class="row">
    <button id="submitBtn" class="primary">完成并提交</button>
    <button id="viewBtn" class="muted">仅查看</button>
  </div>

  <div class="row" id="status"></div>
  <div class="row hint">
    说明：仅使用 GitHub Pages。采用“本机锁定 + 只读链接”防重复；换设备/清缓存仍可能再次提交，群消息会包含 <code>sourceId</code> 便于识别。
  </div>
</div>

<script>
  // ========= 1) 你的默认钉钉机器人配置（建议至少填写 webhook） =========
  const DING_WEBHOOK_DEFAULT = "在这里填你的机器人Webhook"; // 例: https://oapi.dingtalk.com/robot/send?access_token=xxxx
  const DING_SECRET_DEFAULT  = ""; // 若机器人安全=加签，填密钥；若使用“关键字”安全，可留空

  // ========= 2) 读取 URL 参数（可覆盖默认配置） =========
  const P = new URLSearchParams(location.search);
  const subject  = P.get('subject') || '未命名任务';
  const sourceId = (P.get('sourceId') || '').trim();
  const executor = P.get('executorUnionId') || P.get('executor') || '';
  const creator  = P.get('creatorUnionId') || '';
  const readonlyParam = P.get('readonly') === '1';
  const DING_WEBHOOK = decodeURIComponent(P.get('dingWebhook') || '') || DING_WEBHOOK_DEFAULT;
  const DING_SECRET  = decodeURIComponent(P.get('dingSecret')  || '') || DING_SECRET_DEFAULT;

  // ========= 3) 渲染基本信息 =========
  const $ = id => document.getElementById(id);
  $('subject').textContent = subject;
  $('executor').textContent = executor || '(未传)';
  $('sid').textContent     = sourceId || '(未传)';
  const btn = $('submitBtn'), viewBtn = $('viewBtn');
  const remarkEl = $('remark'), statusEl = $('status');

  function setStatus(html){ statusEl.innerHTML = html; }
  function disableSubmit(msg){
    btn.disabled = true; btn.classList.add('disabled');
    remarkEl.readOnly = true;
    if (msg) setStatus(msg);
  }

  // ========= 4) 钉钉加签（如果启用了“加签”安全） =========
  async function signDing(secret, timestamp) {
    const enc = new TextEncoder();
    const key = await crypto.subtle.importKey("raw", enc.encode(secret), {name:"HMAC", hash:"SHA-256"}, false, ["sign"]);
    const sig = await crypto.subtle.sign("HMAC", key, enc.encode(timestamp + "\n" + secret));
    const base64 = btoa(String.fromCharCode(...new Uint8Array(sig)));
    return encodeURIComponent(base64);
  }

  // ========= 5) 发送钉钉消息（Markdown） =========
  async function sendToDingTalk(payload) {
    if (!DING_WEBHOOK) return { ok:false, msg:"未配置钉钉 webhook" };

    let url = DING_WEBHOOK.trim();
    if (DING_SECRET) {
      const ts = Date.now();
      const sign = await signDing(DING_SECRET, ts);
      url += (url.includes('?') ? '&' : '?') + `timestamp=${ts}&sign=${sign}`;
    }

    const text =
`**任务完成**
- 任务：${payload.subject}
- 执行人：${payload.executor || "-"}
- sourceId：${payload.sourceId}
- 备注：${payload.remark || "-"}
- 完成时间：${new Date(payload.ts).toLocaleString('zh-CN')}`;

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json;charset=utf-8" },
      body: JSON.stringify({ msgtype: "markdown", markdown: { title: "任务完成", text } })
    });
    const data = await resp.json().catch(()=> ({}));
    return { ok: data.errcode === 0, msg: JSON.stringify(data) };
  }

  // ========= 6) 进入页面：只读判定（本机锁 + URL） =========
  const LOCK_KEY = sourceId ? 'done_' + sourceId : '';
  (function init(){
    if (!sourceId){ disableSubmit('<span class="err">缺少 sourceId，无法提交。</span>'); return; }
    const localLocked = localStorage.getItem(LOCK_KEY) === '1';
    if (localLocked || readonlyParam) {
      disableSubmit('👀 当前为只读模式。');
    } else {
      setStatus('✅ 可提交。');
    }
  })();

  // ========= 7) 仅查看：不提交，切换只读链接 =========
  viewBtn.addEventListener('click', ()=>{
    disableSubmit('👀 已切换为仅查看模式。');
    const u = new URL(location.href);
    u.searchParams.set('readonly','1');
    history.replaceState(null,'',u.toString());
  });

  // ========= 8) 完成并提交：发钉钉 + 本机锁 + 只读链接 =========
  btn.addEventListener('click', async ()=>{
    if (btn.disabled) return;
    if (!sourceId){ setStatus('<span class="err">缺少 sourceId。</span>'); return; }

    btn.disabled = true; btn.classList.add('disabled');
    setStatus('⏳ 提交中…');
    const payload = {
      subject, sourceId, executor, creator,
      remark: remarkEl.value || '',
      ts: Date.now()
    };

    try {
      const res = await sendToDingTalk(payload);
      if (res.ok) {
        localStorage.setItem(LOCK_KEY, '1');          // 本机锁
        const u = new URL(location.href);             // 切只读链接
        u.searchParams.set('readonly','1');
        history.replaceState(null,'',u.toString());
        disableSubmit('✅ 已提交，已推送到群，页面已锁定为只读。');
      } else {
        setStatus('<span class="err">钉钉推送失败：</span>' + res.msg);
        btn.disabled = false; btn.classList.remove('disabled');
      }
    } catch (e) {
      setStatus('<span class="err">网络异常：</span>' + e);
      btn.disabled = false; btn.classList.remove('disabled');
    }
  });
</script>
</body>
</html>
